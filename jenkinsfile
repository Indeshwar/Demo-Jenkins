pipeline{
    agent{
        docker{
            //install maven and jdk-11 inside the docker
            image 'maven:3.8.1-adoptopenjdk-11'
        }
    }

    stages{
        stage('Checkout'){
            steps{
                git branch: 'main', url: 'https://github.com/Indeshwar/demo-java-jenkins'
            }
        }

        stage('Build and Test'){
            steps{
                //You are calling the mvn executable, which means you need Maven installed on your machine.
                //You are using the clean command, which will delete all previously compiled 
                //Java .class files and resources (like .properties) in your project. Your build will start from a clean slate.
                //Install command will then compile, test & package your Java project and even install/copy your built .jar/.war file into your local Maven repository
                
                //build the project and create a jar file
                sh 'mvn clean package'
            }
        }

        stage('Build and Push Docker Image'){
            enviroment{
                DOCKER_IMAGE = "indeshwar/ultimate-cicd:${BUILD_NUMBER}"
                REGISTRY_CREDENTIALS = credentials('docker-cred')
            }

            steps{
                script {
                    sh 'docker build -t ${DOCKER_IMAGE} .'
                    def dockerImage = docker.image("${DOCKER_IMAGE}")
                    docker.withRegistry('https://index.docker.io/v1', "docker-cred"){
                        dockerImage.Push()
                    }

                }
            }

        }
    }
}